<%- include("partials/sidebar") %>

  <section class="content--body appmain" data-id="<%=trip[0]._id%>">
    <!-- Editable Trip Cover Image -->
    <section class="trip--cover">
      <img class="trip--coverImg" src="<%= trip[0].displayImg %>" alt="">

      <section class="changeCoverImg" data-id="<%=trip[0]._id%>">
        <input class="changeCoverImg-input" type="text" name="displayImg" placeholder="enter URL"><button class="changeCoverImg-btn">Change Cover</button>
      </section>
    </section>

    <!-- Trip Title -->
    <h1 class="trip--title editable" contenteditable="true"><%= trip[0].trip %></h1>
    
    <!-- Trip Overview Section -->
    <section class="trip--overview">
      <section class="overview--details">
        <span class="detail--title">
          <i class="fa-solid fa-user-group"></i> Travelers: </span>
          <!-- Gets all usernames from sharedUsers Object -->
        <span class="detail--value"><%= trip[0].sharedUsers.map(user => Object.values(user)) %></span>
      </section>
      <section class="overview--details">
        <span class="detail--title">
          <i class="fa-solid fa-clock"></i> Created: </span>
          <!-- Formats and gets the date trip was created -->
        <span class="detail--value"><%= trip[0].creationDate.toDateString() %></span>
      </section>
      <section class="overview--details">
        <span class="detail--title">
          <i class="fa-solid fa-location-dot"></i> Stops: </span>
          <!-- Calculates the total number of trip destinations -->
        <span class="detail--value"><%= trip[0].destinations.length %></span>
      </section>
      <section class="overview--details">
        <span class="detail--title">
          <i class="fa-solid fa-calendar-day"></i> Travel Dates: </span>
        <span class="detail--value">
          <% if (trip[0].destinations.length >= 1) { %>
            <!-- Get Earliest Start Date by sorted array at 0th position-->
            <span><%= trip[0].destinations.sort((a,b) => (a.startDate > b.startDate) ? 1 : -1)[0].startDate %> â†’ </span>  
            <!-- Get Latest End Date by sorted array at end position -->
            <span><%= trip[0].destinations.sort((a,b) => (a.startDate > b.startDate) ? 1 : -1)[trip[0].destinations.length - 1].endDate %></span>  
          <% } %>
        </span>
      </section>
    </section>

    <!-- Editable Trip Description -->
    <p class="trip--description editable" contenteditable="true"><%= trip[0].description ? trip[0].description : 'Enter trip description...' %></p> 

    <!-- Trip Destination Card Template EJS -->
    <section class="trip--destinations">
      <h3 class="destination--title">Destinations</h3>

      <!-- Add new destination components -->
      <section class="newDestination" data-id="<%=trip[0]._id%>">
        <input class="newDestination--input" type="text" name="newDestination" placeholder="Add New Destination"><button class="newDestination--btn"><i class="fa-solid fa-plus"></i></button>
      </section>

      <!-- Render destination cards if available -->
      <% if (trip[0].destinations) { %>

        <% trip[0].destinations.sort((a,b) => (a.startDate > b.startDate) ? 1 : -1).map(destination => { %>
          <section class="newDestination--item" data-id="<%=trip[0]._id%>" >
            <!-- Card Icon -->
            <section class="newDestination--icon" data-id="<%=trip[0]._id%>">
              <i class="fa-solid fa-plane"></i>
            </section>

            <!-- Editable Card Information -->
            <section class="newDestination--info" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>" >
              <!-- Location -->
              <h4 class="newDestination--location editable" contenteditable="true"> <%= destination.location %> </h4> 
              <!-- Start - End Dates -->
              <section class="newDestination--dates" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>">
                <input class="destination--startDate" type="date" name="destination--startDate" id="" value="<%= destination.startDate %>">
                <input class="destination--endDate" type="date" 
                name="destination--endDate" id="" value="<%= destination.endDate %>">
              </section>
            </section>

            <!-- Card Btns -->
            <section class="newDestination--btns" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>" >
              <a href="#<%= destination.location %>"><i class="editDestination--btn fa-solid fa-expand"></i></a>
              <i class="deleteDestination--btn fa-solid fa-trash-can"></i>
            </section>
          </section>

          <!-- Destination Expanded Modal -->
          <section id="<%= destination.location %>" class="modal expanded">
            <section class="modal--content expanded" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>">
              <!-- Location -->
              <h2 class="newDestination--location editable" contenteditable="true"><%= destination.location %></h2>

              <!-- Destination Content Tabs -->
              <section class="content--nav">
                <button class="content--tabs tab--overview active">Overview</button>
                <button class="content--tabs tab--itinerary">Itinerary</button>
                <button class="content--tabs tab--travel">Flights/Travel</button>
                <button class="content--tabs tab--accomodations">Accomodations</button>
              </section>

              <!-- Destination Content -->
              <section class="content--area">
                <section class="content--areaDisplay areaDisplay--overview active" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>">
                  <!-- Start - End Dates -->
                  <h3 class="areaDisplay--titles">Dates</h3>
                  <section class="newDestination--dates" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>">
                    <label for="destination--startDate">Start</label>
                    <input class="destination--startDate" type="date" name="destination--startDate" id="" value="<%= destination.startDate %>">
                    <label for="destination--endDate">End</label>
                    <input class="destination--endDate" type="date" 
                      name="destination--endDate" id="" value="<%= destination.endDate %>">
                  </section>

                  <h3 class="areaDisplay--titles">Accomodations</h3>
                    <% if (destination.accomodations) { %>
                      <p>You have <b> <%= destination.accomodations.length %> </b> planned <%= destination.accomodations.length === 1 ? "accomodation" : "accomodations" %>.</p>
                    <% } else { %>
                      <p>You have no planned accomodations.</p>
                    <% } %>

                  <!-- Editable Notes -->
                  <p class="destination--notes editable" contenteditable="true"><%= destination.notes ? destination.notes : "Add notes..." %></p>

                </section>

                <section class="content--areaDisplay areaDisplay--itinerary">
                  <h3 class="areaDisplay--titles">Log</h3>

                </section>

                <section class="content--areaDisplay areaDisplay--travel">
                  <h3 class="areaDisplay--titles">Tickets</h3>

                </section>

                <section class="content--areaDisplay areaDisplay--accomodations">
                  <!-- Add Accomodation formset -->
                  <h3 class="areaDisplay--titles">Add Accomodation</h3>
                  <form class="destinationDetail--form" action="/tripEditor/addAccomodation/<%=trip[0]._id%>/<%=destination.location%>?_method=PUT" method='POST'>
                    <section class="destinationDetail--form__single">
                      <!-- Add accomodation address -->
                      <label class="destinationDetail--label" for="accomodationAddress">Address</label>
                      <input class="destinationDetail--inpt" type="text" name="accomodationAddress" placeholder="P. Sherman 42 Wallaby Way">
                    </section>
                    
                    <section class="destinationDetail--form__multi">
                      <section>
                        <!-- Add accomodation confirmation code -->
                        <label class="destinationDetail--label" for="accomodationConfirmation">Confirmation</label>
                        <input class="destinationDetail--inpt" type="text" name="accomodationConfirmation" placeholder="REF421A">
                      </section>

                      <section>
                        <!-- Select type of accomodation -->
                        <label class="destinationDetail--label" for="accomodationType">Type</label>
                        <input class="destinationDetail--inpt" list="select--accomodation" name="accomodationType" placeholder="Select Type">
                        <datalist class="" id="select--accomodation">
                          <option value="Hotel">Hotel</option>
                          <option value="AirBnb">AirBnb</option>
                          <option value="Vrbo">Vrbo</option>
                          <option value="Rental">Rental</option>
                          <option value="Other">Other</option>
                        </datalist>
                      </section>

                      <!-- Add Stay dates -->
                      <section>
                        <label class="destinationDetail--label" for="accomodationStartDate">Start</label>
                        <input class="destinationDetail--inpt" type="date" name="accomodationStartDate" value="<%= destination.startDate %>" min="<%= destination.startDate %>">
                      </section>
                      
                      <!-- Add Stay dates -->
                      <section>
                        <label class="destinationDetail--label" for="accomodationEndDate">End</label>
                        <input class="destinationDetail--inpt" type="date" name="accomodationEndDate" value="<%= destination.endDate %>" max="<%= destination.endDate %>">
                      </section>
                    </section>

                    <!-- Submit form btn -->
                    <section class="destinationDetail--form__single right">
                      <input class="destinationDetail--form__submit" type="submit">
                    </section>
                    
                  </form>

                  <!-- View Accomodations -->
                  <section class="newAccomodation">
                  <% if (destination.accomodations) { %>
                    <% destination.accomodations.map(accomodation => { %>
                        <section class="newAccomodation--item" data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>" data-accom="<%= accomodation.accomAddress %>"> 
                          <section class="newAccomodation--item__main" >
                            <h4 data-id="<%=trip[0]._id%>" data-loc="<%= destination.location %>" data-accom="<%= accomodation.accomAddress %>"><%= accomodation.accomType %> <i class="deleteAccom--btn fa-solid fa-trash-can"></i> </h4>
                            <div> <%= accomodation.accomConfirmation %> </div>
                          </section>

                          <section class="newAccomodation--item__details"> 
                            <section class="details--dates">
                              <div> <%= accomodation.accomStartDate %> </div>
                              <div> <%= accomodation.accomEndDate %> </div>
                            </section>
                            <section class="details--address">
                              <div> <a target="_blank" href="https://www.google.com/maps/search/<%=accomodation.accomAddress%>"> <%= accomodation.accomAddress %> </a></div>
                            </section>
                          </section>   
                        </section>                     
                    <% }) %>
                  <% } %>
                  </section>

                </section>
              </section>

              <!-- Close Modal Btn -->
              <a href="#" class="modal--close">&times;</a>
            </section>
          </section>

        <% }) %>
      <% } %>

    </section>
    
  </section>
  <script src="/js/tripsEditor.js"></script>
  </body>
</html>